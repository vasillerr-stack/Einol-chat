<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enjol Messenger MAX</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(20, 25, 40, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #ff007f;
            --accent-hover: #ff4d94;
            --text-main: #ffffff;
            --text-muted: #a0a5b5;
            --msg-in: rgba(45, 55, 80, 0.8);
            --msg-out: linear-gradient(135deg, #ff007f, #7000ff);
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body, html { 
            height: 100%; 
            font-family: 'Montserrat', sans-serif; 
            color: var(--text-main); 
            overflow: hidden;
            background: #05050f;
        }

        .glass { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); }

        /* Toasts */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 15px; font-size: 13px; text-align: center; animation: slideDown 0.3s ease; border: 1px solid var(--glass-border); }
        .toast.error { border-left: 4px solid #ff4d4d; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* Auth */
        #auth-screen { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1a1a2e, #05050f); }
        .auth-card { padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 360px; }
        .auth-card input { width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 10px; }
        .btn-main { width: 100%; padding: 12px; background: var(--accent); border: none; color: white; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 10px; }

        /* Main App */
        #app { display: none; height: 100vh; grid-template-columns: 300px 1fr; }
        .sidebar { border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        .side-header { padding: 15px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-radius: 10px; margin-bottom: 5px; transition: 0.2s; }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        
        .avatar { width: 40px; height: 40px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        
        .chat-window { display: flex; flex-direction: column; background: rgba(0,0,0,0.1); }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 14px; position: relative; }
        .msg.in { align-self: flex-start; background: var(--msg-in); }
        .msg.out { align-self: flex-end; background: var(--msg-out); }
        .msg img { max-width: 100%; border-radius: 8px; }

        .input-area { padding: 15px; display: flex; gap: 10px; border-top: 1px solid var(--glass-border); }
        .input-area input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 10px 15px; border-radius: 20px; color: white; }

        @media (max-width: 768px) {
            #app { grid-template-columns: 100%; }
            .sidebar.hidden { display: none; }
            .chat-window { display: none; }
            .chat-window.active { display: flex; position: fixed; inset: 0; z-index: 100; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="channel-modal" class="glass" style="display: none; position: fixed; inset: 0; z-index: 2000; align-items: center; justify-content: center;">
    <div class="auth-card glass">
        <h3>–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª</h3>
        <input type="text" id="channel-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä #news)">
        <button class="btn-main" onclick="createChannel()">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn-main" style="background:transparent" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="auth-screen">
    <div class="auth-card glass">
        <h2 id="auth-title">–í–•–û–î</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="text" id="nickname" placeholder="–ù–∏–∫ (@name)" style="display:none">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-main" id="main-btn" onclick="handleAuth()">–í–û–ô–¢–ò</button>
        <div style="margin-top:15px; font-size:12px; cursor:pointer" onclick="toggleAuthMode()" id="toggle-text">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</div>
    </div>
</div>

<div id="app">
    <div class="sidebar glass" id="sidebar">
        <div class="side-header">
            <span id="my-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <span onclick="auth.signOut()" style="cursor:pointer">üö™</span>
        </div>
        <div style="padding: 10px;">
            <input type="text" id="friend-search" placeholder="–ü–æ–∏—Å–∫ @–Ω–∏–∫ –∏–ª–∏ #–∫–∞–Ω–∞–ª" 
                   style="width:100%; padding:8px; border-radius:8px; background:rgba(0,0,0,0.2); border:1px solid var(--glass-border); color:white"
                   onkeypress="if(event.key==='Enter') searchTarget()">
            <div onclick="openModal()" style="font-size:11px; color:var(--accent); margin-top:10px; cursor:pointer; text-align:center">+ –°–û–ó–î–ê–¢–¨ –ö–ê–ù–ê–õ</div>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <div class="chat-window" id="chat-window">
        <div class="side-header glass" id="chat-header" style="display:none">
            <button onclick="closeChat()" style="background:none; border:none; color:white; margin-right:10px">‚¨Ö</button>
            <strong id="chat-title">–ß–∞—Ç</strong>
        </div>
        <div class="messages" id="msg-container"></div>
        <div class="input-area" id="input-area" style="display:none">
            <input type="text" id="m-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="sendMsg()" style="background:none; border:none; color:var(--accent); font-size:20px">‚û§</button>
        </div>
    </div>
</div>

<script>
    // –¢–í–û–ô –ö–û–ù–§–ò–ì (–û—Å—Ç–∞–≤—å —Å–≤–æ–π!)
    const firebaseConfig = {
        apiKey: "AIzaSyBoFqIEnH2J-d0dBe9FJ7cQWATr9n5fKDk",
        authDomain: "einol-6fbf6.firebaseapp.com",
        projectId: "einol-6fbf6",
        storageBucket: "einol-6fbf6.firebasestorage.app",
        messagingSenderId: "430869133379",
        appId: "1:430869133379:web:6c6ca70527c521b98ffcf6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    let isRegMode = false;
    let currentChatId = null;

    function showToast(m, type='success') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerText = m;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function toggleAuthMode() {
        isRegMode = !isRegMode;
        document.getElementById('nickname').style.display = isRegMode ? 'block' : 'none';
        document.getElementById('auth-title').innerText = isRegMode ? '–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø' : '–í–•–û–î';
    }

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const nick = document.getElementById('nickname').value.trim().toLowerCase(); // –í –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä!

        try {
            if (isRegMode) {
                if (!nick.startsWith('@')) return showToast("–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å @", "error");
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await res.user.updateProfile({ displayName: nick });
                await db.collection("users").doc(res.user.uid).set({ nick, uid: res.user.uid, email });
            } else {
                await auth.signInWithEmailAndPassword(email, pass);
            }
        } catch (e) { showToast(e.message, "error"); }
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'grid';
            document.getElementById('my-name').innerText = user.displayName;
            loadChats();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }
    });

    // –ü–û–ò–°–ö
    async function searchTarget() {
        let q = document.getElementById('friend-search').value.trim().toLowerCase();
        if (!q) return;

        try {
            if (q.startsWith('#')) {
                const snap = await db.collection("chats").where("name", "==", q).get();
                if (snap.empty) return showToast("–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");
                const cid = snap.docs[0].id;
                await db.collection("chats").doc(cid).update({
                    users: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)
                });
                openChat(cid, q);
            } else if (q.startsWith('@')) {
                const snap = await db.collection("users").where("nick", "==", q).get();
                if (snap.empty) return showToast("–Æ–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");
                const f = snap.docs[0].data();
                const my = auth.currentUser.uid;
                const cid = my < f.uid ? my+'_'+f.uid : f.uid+'_'+my;
                await db.collection("chats").doc(cid).set({
                    users: [my, f.uid],
                    nicks: [auth.currentUser.displayName, f.nick],
                    isChannel: false
                }, {merge: true});
                openChat(cid, f.nick);
            }
        } catch (e) { 
            console.error(e);
            showToast("–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å (F12)", "error"); 
        }
    }

    function loadChats() {
        // –ï—Å–ª–∏ –∫–∞–Ω–∞–ª—ã –ø—Ä–æ–ø–∞–¥–∞—é—Ç ‚Äî –∑–Ω–∞—á–∏—Ç —Ç—É—Ç –Ω—É–∂–µ–Ω –ò–ù–î–ï–ö–° –≤ Firebase
        db.collection("chats").where("users", "array-contains", auth.currentUser.uid)
        .onSnapshot(snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const name = d.isChannel ? d.name : (d.nicks.find(n => n !== auth.currentUser.displayName) || "–ß–∞—Ç");
                const item = document.createElement('div');
                item.className = "chat-item glass";
                item.innerHTML = `<div class="avatar">${d.isChannel ? '#' : name[1].toUpperCase()}</div><div>${name}</div>`;
                item.onclick = () => openChat(doc.id, name);
                list.appendChild(item);
            });
        }, err => {
            console.log("–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò:", err.message);
            if(err.message.includes("index")) showToast("–ù—É–∂–µ–Ω –∏–Ω–¥–µ–∫—Å! –°–º. –∫–æ–Ω—Å–æ–ª—å F12", "error");
        });
    }

    function openChat(id, name) {
        currentChatId = id;
        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        document.getElementById('chat-title').innerText = name;
        if(window.innerWidth <= 768) {
            document.getElementById('chat-window').classList.add('active');
        }

        db.collection("chats").doc(id).collection("messages").orderBy("timestamp", "asc")
        .onSnapshot(snap => {
            const c = document.getElementById('msg-container');
            c.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data();
                const div = document.createElement('div');
                div.className = `msg ${m.sender === auth.currentUser.uid ? 'out' : 'in'}`;
                div.innerText = m.text;
                c.appendChild(div);
            });
            c.scrollTop = c.scrollHeight;
        });
    }

    function sendMsg() {
        const i = document.getElementById('m-input');
        if (!i.value || !currentChatId) return;
        db.collection("chats").doc(currentChatId).collection("messages").add({
            text: i.value,
            sender: auth.currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        i.value = "";
    }

    function closeChat() { document.getElementById('chat-window').classList.remove('active'); }
    function openModal() { document.getElementById('channel-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('channel-modal').style.display = 'none'; }

    async function createChannel() {
        let n = document.getElementById('channel-name').value.trim().toLowerCase();
        if(!n.startsWith('#')) n = '#' + n;
        await db.collection("chats").add({
            name: n,
            isChannel: true,
            users: [auth.currentUser.uid],
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast("–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω!");
    }
</script>
</body>
</html>
