<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enjol Messenger MAX</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #000000;
            --bg-panel: #0a0a0b;
            --bg-item: #161618;
            --accent: #7c4dff;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
            --msg-out: #2c2c2e;
            --msg-in: #1c1c1e;
            --radius-xl: 24px;
            --radius-m: 14px;
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; font-family: 'Montserrat', sans-serif; background: var(--bg-deep); color: var(--text-main); overflow: hidden; }

        #app { display: none; height: 100vh; width: 100vw; display: flex; position: relative; }

        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar { 
            width: 360px; background: var(--bg-panel); border-right: 1px solid #1a1a1a; 
            display: flex; flex-direction: column; z-index: 10; transition: transform 0.3s ease;
        }
        
        /* –ü–æ–∏—Å–∫ */
        .search-box { padding: 10px 15px; position: relative; }
        .search-box input { 
            width: 100%; padding: 12px 15px; background: var(--bg-item); border: 1px solid #222; 
            border-radius: 12px; color: white; font-size: 14px;
        }
        #search-results {
            position: absolute; top: 60px; left: 15px; right: 15px; background: var(--bg-item);
            border-radius: 12px; border: 1px solid #333; z-index: 100; display: none; max-height: 200px; overflow-y: auto;
        }

        /* –û–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-window { 
            flex: 1; display: flex; flex-direction: column; background: var(--bg-deep); 
            z-index: 5; transition: transform 0.3s ease;
        }

        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; inset: 0; }
            .chat-window { width: 100%; position: absolute; inset: 0; transform: translateX(100%); }
            body.chat-open .sidebar { transform: translateX(-100%); }
            body.chat-open .chat-window { transform: translateX(0); z-index: 20; }
        }

        .side-header, .chat-header { padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #1a1a1a; min-height: 70px; }
        .back-btn { display: none; cursor: pointer; font-size: 24px; color: var(--accent); }
        @media (max-width: 768px) { .back-btn { display: block; } }

        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: var(--radius-m); cursor: pointer; margin-bottom: 5px; transition: 0.2s; }
        .chat-item:hover { background: var(--bg-item); }

        .avatar { width: 48px; height: 48px; border-radius: 16px; background: #2c2c2e; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }

        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; position: relative; font-size: 15px; }
        .msg.in { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 4px; }
        .msg.out { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 4px; }
        .msg-sender { font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 4px; display: block; }
        .msg-info { font-size: 10px; opacity: 0.5; margin-top: 5px; text-align: right; }
        .date-divider { text-align: center; margin: 20px 0; color: var(--text-dim); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }

        .input-area { padding: 15px 20px 30px; display: flex; align-items: center; gap: 12px; }
        .input-wrapper { flex: 1; background: var(--bg-item); border-radius: 15px; padding: 5px 15px; border: 1px solid #222; }
        .input-wrapper input { width: 100%; background: transparent; border: none; color: white; padding: 10px 0; font-size: 16px; }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2999; display: none; backdrop-filter: blur(5px); }
        #drawer, #user-modal { position: fixed; left: -100%; top: 0; bottom: 0; width: 300px; background: var(--bg-panel); z-index: 3000; transition: 0.4s; padding: 40px 20px; border-right: 1px solid #1a1a1a; }
        #drawer.open, #user-modal.open { left: 0; }
        
        #auth-screen { position: fixed; inset: 0; background: black; z-index: 4000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body id="body-tag">

<div id="overlay" onclick="closeAll()"></div>

<div id="user-modal">
    <div style="text-align: center;">
        <div class="avatar" id="view-user-emoji" style="width: 100px; height: 100px; font-size: 50px; margin: 0 auto 20px; border-radius: 30px;">üë§</div>
        <h2 id="view-user-nick">@nick</h2>
        <div id="owner-badge" style="display:none; color:#ff9500; font-size:12px; font-weight:bold; margin-top:5px;">‚òÖ OWNER</div>
        <p id="view-user-about" style="color: var(--text-dim); margin-top: 15px; white-space: pre-wrap;"></p>
    </div>
    <button onclick="closeAll()" style="width:100%; margin-top: 30px; padding: 12px; border-radius: 10px; background: var(--bg-item); color: white; border: none; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div id="drawer">
    <div style="text-align: center;">
        <div class="avatar" id="my-emoji-display" onclick="changeEmoji()" style="width: 80px; height: 80px; font-size: 40px; margin: 0 auto 15px; cursor: pointer;">üë§</div>
        <h2 id="my-nick-display">@nick</h2>
    </div>
    <div style="margin-top: 30px;">
        <label style="font-size: 11px; color: var(--text-dim);">–û –°–ï–ë–ï</label>
        <textarea id="edit-about" style="width: 100%; background: var(--bg-item); border: 1px solid #222; border-radius: 10px; color: white; padding: 12px; margin-top: 8px; resize: none; height: 80px;"></textarea>
        <button onclick="saveProfile()" style="width:100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; margin-top: 10px; cursor: pointer; font-weight: 600;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div id="admin-panel" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
        <p style="color: #ff9500; font-size: 11px;">ADIMN MENU</p>
        <button onclick="alert('–í—ã ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–î –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase.')" style="width:100%; padding: 10px; background: #333; color: white; border-radius: 8px; margin-top: 10px; border: none; cursor: pointer;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>
    <button onclick="auth.signOut()" style="position: absolute; bottom: 30px; left: 20px; color: #ff453a; background: none; border: none; cursor: pointer;">–í—ã—Ö–æ–¥</button>
</div>

<div id="auth-screen">
    <div style="background: var(--bg-panel); padding: 40px; border-radius: var(--radius-xl); width: 90%; max-width: 360px; text-align: center;">
        <h2 id="auth-title">Enjol</h2>
        <input type="email" id="email" placeholder="Email" style="width:100%; padding:14px; margin: 20px 0 10px; background: var(--bg-item); border: 1px solid #222; color: white; border-radius: 10px;">
        <input type="text" id="nickname" placeholder="@nick" style="display:none; width:100%; padding:14px; margin-bottom: 10px; background: var(--bg-item); border: 1px solid #222; color: white; border-radius: 10px;">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%; padding:14px; margin-bottom: 20px; background: var(--bg-item); border: 1px solid #222; color: white; border-radius: 10px;">
        <button onclick="handleAuth()" style="width:100%; padding: 14px; background: white; color: black; border: none; border-radius: 10px; font-weight: 600;">–í–æ–π—Ç–∏</button>
        <p onclick="toggleAuthMode()" id="toggle-text" style="color: var(--text-dim); margin-top: 20px; cursor: pointer; font-size: 13px;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
    </div>
</div>

<div id="app">
    <div class="sidebar" id="sidebar">
        <div class="side-header">
            <div onclick="openDrawer()" style="cursor:pointer; font-size: 20px;">‚ò∞</div>
            <div style="font-weight: 600; flex: 1; text-align: center;">Enjol</div>
        </div>
        <div class="search-box">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ @–Ω–∏–∫–∞–º..." oninput="liveSearch()">
            <div id="search-results"></div>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <div class="chat-window" id="chat-window">
        <div class="chat-header" id="chat-header" style="display:none">
            <div class="back-btn" onclick="backToList()">‚Üê</div>
            <div class="avatar" id="active-chat-ava" onclick="viewPartnerProfile()" style="width: 40px; height: 40px; font-size: 18px; cursor: pointer;">üë§</div>
            <div style="flex:1">
                <div id="chat-title" style="font-weight: 600;">–ß–∞—Ç</div>
                <div id="chat-status" style="font-size: 11px; color: var(--accent);">online</div>
            </div>
        </div>
        <div class="messages" id="msg-container"></div>
        <div class="input-area" id="input-area" style="display:none">
            <div class="input-wrapper"><input type="text" id="m-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMsg()"></div>
            <div onclick="sendMsg()" style="cursor:pointer; font-size: 22px; color: var(--accent);">‚û§</div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBoFqIEnH2J-d0dBe9FJ7cQWATr9n5fKDk",
        authDomain: "einol-6fbf6.firebaseapp.com",
        projectId: "einol-6fbf6",
        storageBucket: "einol-6fbf6.firebasestorage.app",
        messagingSenderId: "430869133379",
        appId: "1:430869133379:web:6c6ca70527c521b98ffcf6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const OWNER_UID = "MyGoO65rfh6ceu3hzxrfrkq2OqfY2";
    let isRegMode = false;
    let currentChatId = null;
    let currentPartnerUid = null;
    let myEmoji = "üë§";
    let lastDateLabel = "";

    // --- UI Helpers ---
    function openDrawer() { document.getElementById('drawer').classList.add('open'); document.getElementById('overlay').style.display = 'block'; }
    function closeAll() { 
        document.getElementById('drawer').classList.remove('open'); 
        document.getElementById('user-modal').classList.remove('open'); 
        document.getElementById('overlay').style.display = 'none'; 
    }
    function backToList() { document.getElementById('body-tag').classList.remove('chat-open'); }

    // --- –ü–æ–∏—Å–∫ ---
    async function liveSearch() {
        const q = document.getElementById('search-input').value.trim().toLowerCase();
        const resDiv = document.getElementById('search-results');
        if (q.length < 1) { resDiv.style.display = 'none'; return; }
        
        resDiv.innerHTML = ""; resDiv.style.display = 'block';
        const snap = await db.collection("users").where("nick", ">=", q).where("nick", "<=", q + '\uf8ff').limit(5).get();
        
        snap.forEach(doc => {
            const u = doc.data();
            if (u.uid === auth.currentUser.uid) return;
            const d = document.createElement('div');
            d.style.padding = "10px"; d.style.cursor = "pointer"; d.style.borderBottom = "1px solid #222";
            d.innerHTML = `${u.emoji || 'üë§'} @${u.nick}`;
            d.onclick = () => { startPrivateChat(u.uid, u.nick, u.emoji); resDiv.style.display = 'none'; };
            resDiv.appendChild(d);
        });
    }

    async function startPrivateChat(fUid, fNick, fEmoji) {
        const my = auth.currentUser.uid;
        const cid = my < fUid ? my+'_'+fUid : fUid+'_'+my;
        await db.collection("chats").doc(cid).set({
            users: [my, fUid], 
            nicks: [auth.currentUser.displayName, fNick],
            emojis: [myEmoji, fEmoji || "üë§"],
            isChannel: false
        }, {merge: true});
        openChat(cid, fNick, fEmoji || "üë§", fUid);
    }

    // --- –ü—Ä–æ—Ñ–∏–ª—å ---
    function changeEmoji() {
        const emo = ["üë§","üê±","ü¶ä","ü§ñ","üëª","üëΩ","üåü","üî•","üíé","üçÑ","üçÄ","üëë"];
        myEmoji = emo[Math.floor(Math.random()*emo.length)];
        document.getElementById('my-emoji-display').innerText = myEmoji;
    }

    async function saveProfile() {
        const about = document.getElementById('edit-about').value;
        await db.collection("users").doc(auth.currentUser.uid).update({ about, emoji: myEmoji });
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
    }

    async function viewPartnerProfile() {
        if (!currentPartnerUid) return;
        const doc = await db.collection("users").doc(currentPartnerUid).get();
        if (doc.exists) {
            const u = doc.data();
            document.getElementById('view-user-emoji').innerText = u.emoji || "üë§";
            document.getElementById('view-user-nick').innerText = "@" + u.nick;
            document.getElementById('view-user-about').innerText = u.about || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.";
            document.getElementById('owner-badge').style.display = (u.uid === OWNER_UID) ? "block" : "none";
            document.getElementById('user-modal').classList.add('open');
            document.getElementById('overlay').style.display = 'block';
        }
    }

    // --- –ß–∞—Ç ---
    function openChat(id, name, emoji, partnerUid = null) {
        currentChatId = id;
        currentPartnerUid = partnerUid;
        lastDateLabel = "";
        
        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        document.getElementById('chat-title').innerText = name;
        document.getElementById('active-chat-ava').innerText = emoji;
        document.getElementById('body-tag').classList.add('chat-open');

        db.collection("chats").doc(id).collection("messages").orderBy("timestamp", "asc")
        .onSnapshot(snap => {
            const container = document.getElementById('msg-container');
            container.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data();
                if (!m.timestamp) return;
                
                const date = m.timestamp.toDate();
                const day = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
                
                if (day !== lastDateLabel) {
                    const divD = document.createElement('div');
                    divD.className = "date-divider"; divD.innerText = day;
                    container.appendChild(divD);
                    lastDateLabel = day;
                }

                const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                const isOut = m.sender === auth.currentUser.uid;
                
                const div = document.createElement('div');
                div.className = `msg ${isOut ? 'out' : 'in'}`;
                
                // –î–ª—è –∫–∞–Ω–∞–ª–æ–≤ –ø–∏—à–µ–º –Ω–∏–∫
                let senderMarkup = (!isOut && partnerUid === null) ? `<span class="msg-sender">${m.senderNick || 'User'}</span>` : "";
                
                div.innerHTML = `${senderMarkup}${m.text}<div class="msg-info">${time}</div>`;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        });
    }

    function sendMsg() {
        const val = document.getElementById('m-input').value.trim();
        if (!val || !currentChatId) return;
        db.collection("chats").doc(currentChatId).collection("messages").add({
            text: val,
            sender: auth.currentUser.uid,
            senderNick: auth.currentUser.displayName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('m-input').value = "";
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ Auth ---
    function loadChats() {
        db.collection("chats").where("users", "array-contains", auth.currentUser.uid)
        .onSnapshot(snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const isCh = d.isChannel === true;
                const name = isCh ? d.name : d.nicks.find(n => n !== auth.currentUser.displayName);
                const icon = isCh ? "üì¢" : (d.emojis ? (d.users[0] === auth.currentUser.uid ? d.emojis[1] : d.emojis[0]) : "üë§");
                const partner = isCh ? null : d.users.find(u => u !== auth.currentUser.uid);
                
                const item = document.createElement('div');
                item.className = "chat-item";
                item.innerHTML = `<div class="avatar">${icon}</div><div><div style="font-weight:600">${name}</div><div style="font-size:12px;color:var(--text-dim)">${isCh ? '–ö–∞–Ω–∞–ª' : '–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}</div></div>`;
                item.onclick = () => openChat(doc.id, name, icon, partner);
                list.appendChild(item);
            });
        });
    }

    auth.onAuthStateChanged(async user => {
        if (user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('my-nick-display').innerText = "@" + user.displayName;
            if (user.uid === OWNER_UID) document.getElementById('admin-panel').style.display = 'block';
            
            const uDoc = await db.collection("users").doc(user.uid).get();
            if (uDoc.exists) {
                myEmoji = uDoc.data().emoji || "üë§";
                document.getElementById('my-emoji-display').innerText = myEmoji;
                document.getElementById('edit-about').value = uDoc.data().about || "";
            }
            loadChats();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
    });

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const nick = document.getElementById('nickname').value.trim().toLowerCase();
        try {
            if (isRegMode) {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await res.user.updateProfile({ displayName: nick });
                await db.collection("users").doc(res.user.uid).set({ nick, uid: res.user.uid, emoji: "üë§", about: "" });
            } else { await auth.signInWithEmailAndPassword(email, pass); }
        } catch (e) { alert(e.message); }
    }

    function toggleAuthMode() {
        isRegMode = !isRegMode;
        document.getElementById('nickname').style.display = isRegMode ? 'block' : 'none';
        document.getElementById('auth-title').innerText = isRegMode ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í—Ö–æ–¥';
        document.getElementById('toggle-text').innerText = isRegMode ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏' : '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –°–æ–∑–¥–∞—Ç—å';
    }
</script>
</body>
</html>
