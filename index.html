<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enjol Messenger MAX</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(20, 25, 40, 0.55);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #ff007f;
            --accent-hover: #ff4d94;
            --text-main: #ffffff;
            --text-muted: #a0a5b5;
            --msg-in: rgba(45, 55, 80, 0.8);
            --msg-out: linear-gradient(135deg, #ff007f, #7000ff);
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body, html { 
            height: 100%; 
            font-family: 'Montserrat', sans-serif; 
            color: var(--text-main); 
            overflow: hidden;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #240b36, #05050f);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
        }

        /* --- –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Toasts) --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: rgba(20,25,40,0.95); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); color: white; padding: 15px 20px; border-radius: 20px; font-size: 13px; font-weight: 500; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideDown 0.4s ease forwards; }
        .toast.error { border-left: 4px solid #ff4d4d; }
        .toast.success { border-left: 4px solid #00ff88; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è --- */
        #auth-screen { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .auth-card { padding: 40px; border-radius: 24px; text-align: center; width: 90%; max-width: 380px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .auth-card h2 { margin-bottom: 20px; font-weight: 700; letter-spacing: 1px; }
        .auth-card input { width: 100%; padding: 15px; margin: 8px 0; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 12px; font-size: 14px; transition: 0.3s; }
        .auth-card input:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); }
        .btn-main { width: 100%; padding: 15px; background: var(--accent); border: none; color: white; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 15px; transition: 0.3s; box-shadow: 0 4px 15px rgba(255, 0, 127, 0.4); }
        .btn-main:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .auth-toggle { margin-top: 20px; font-size: 13px; color: var(--text-muted); cursor: pointer; transition: 0.3s; }
        .auth-toggle:hover { color: white; }
        #auth-info { font-size: 13px; margin-top: 15px; min-height: 18px; font-weight: 500; }

        /* --- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ --- */
        #app { display: none; height: 100vh; grid-template-columns: 320px 1fr; }
        
        .sidebar { border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; z-index: 10; }
        .side-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .search-box { padding: 15px; border-bottom: 1px solid var(--glass-border); }
        .search-box input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; color: white; font-size: 13px; }
        
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { padding: 12px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-radius: 12px; transition: 0.2s; margin-bottom: 5px; }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .avatar { width: 45px; height: 45px; background: linear-gradient(45deg, #ff007f, #ff8c00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); flex-shrink: 0; }
        
        .chat-window { display: flex; flex-direction: column; position: relative; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); z-index: 5;}
        
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 65%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; position: relative; word-wrap: break-word; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .msg.in { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 4px; border: 1px solid var(--glass-border); }
        .msg.out { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 4px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .msg audio { max-width: 250px; height: 40px; outline: none; margin-top: 5px;}
        
        .input-area { padding: 20px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--glass-border); display: flex; gap: 10px; align-items: center; backdrop-filter: blur(10px); }
        .input-area input[type="text"] { flex: 1; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); padding: 15px 20px; border-radius: 24px; color: white; font-size: 14px; transition: 0.3s; }
        .input-area input[type="text"]:focus { border-color: var(--accent); }
        
        .icon-btn { background: transparent; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 10px; transition: 0.2s; border-radius: 50%; display: flex; align-items: center; justify-content: center;}
        .icon-btn:hover { color: white; background: rgba(255,255,255,0.1); }
        .icon-btn.recording { color: #ff007f; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 127, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 0, 127, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 127, 0); }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø (–î–û–ë–ê–í–õ–ï–ù–û) --- */
        .back-btn { display: none; background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 5px; }
        @media (max-width: 768px) {
            #app { grid-template-columns: 100%; }
            .sidebar { width: 100%; }
            .chat-window { display: none; width: 100%; }
            .sidebar.hidden-mobile { display: none; }
            .chat-window.active-mobile { display: flex; height: 100vh; }
            .back-btn { display: block; }
            .msg { max-width: 85%; }
            .auth-card { padding: 30px 20px; }
            .input-area { padding: 10px 15px; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="channel-modal" class="glass" style="display: none; position: fixed; inset: 0; z-index: 2000; align-items: center; justify-content: center;">
    <div class="auth-card glass">
        <h3 style="margin-bottom: 15px;">–°–æ–∑–¥–∞—Ç—å –ö–∞–Ω–∞–ª</h3>
        <input type="text" id="channel-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä #memes)">
        <button class="btn-main" onclick="createChannel()">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn-main" style="background: transparent; border: 1px solid var(--glass-border); margin-top: 10px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="auth-screen" class="glass">
    <div class="auth-card glass">
        <h2 id="auth-title">–í–•–û–î</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="text" id="nickname" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫ (@ferrum)" style="display:none">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-main" id="main-btn" onclick="handleAuth()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
        <div class="auth-toggle" onclick="toggleAuthMode()" id="toggle-text">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</div>
        <p id="auth-info"></p>
    </div>
</div>

<div id="app">
    <div class="sidebar glass" id="sidebar">
        <div class="side-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="avatar" id="my-avatar" style="width: 35px; height: 35px; font-size: 14px;">?</div>
                <strong id="my-name">–ó–∞–≥—Ä—É–∑–∫–∞...</strong>
            </div>
            <span onclick="logout()" style="cursor:pointer; font-size:20px;" title="–í—ã—Ö–æ–¥">üö™</span>
        </div>
        <div class="search-box">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="friend-search" placeholder="–ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞ (@–Ω–∏–∫) –∏–ª–∏ –∫–∞–Ω–∞–ª (#–∏–º—è)..." onkeypress="if(event.key==='Enter') searchTarget()">
                <button class="icon-btn" onclick="searchTarget()" style="background: var(--accent); color: white; width: 42px; height: 42px;">üîç</button>
            </div>
            <div style="margin-top: 15px; font-size: 12px; color: var(--accent); text-align: center; cursor: pointer; font-weight: 600;" onclick="openModal()">
                + –°–û–ó–î–ê–¢–¨ –°–í–û–ô –ö–ê–ù–ê–õ
            </div>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>
    
    <div class="chat-window" id="chat-window">
        <div class="chat-header glass" id="chat-header" style="display: none;">
            <button class="back-btn" onclick="closeChatMobile()">‚¨ÖÔ∏è</button>
            <div class="avatar" id="chat-avatar">?</div>
            <h3 id="chat-title" style="margin: 0; font-weight: 600;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
        </div>
        
        <div class="messages" id="msg-container">
            <div style="text-align: center; color: var(--text-muted); margin-top: 50px;">
                –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –¥—Ä—É–≥–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ ‚ú®
            </div>
        </div>
        
        <div class="input-area" id="input-area" style="display: none;">
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="uploadImage(event)">
            <button class="icon-btn" onclick="document.getElementById('file-input').click()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
            
            <input type="text" id="m-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMsg()">
            
            <button class="icon-btn" id="mic-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()" title="–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –ì–°">üé§</button>
            
            <button class="icon-btn" style="color: var(--accent);" onclick="sendMsg()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBoFqIEnH2J-d0dBe9FJ7cQWATr9n5fKDk",
        authDomain: "einol-6fbf6.firebaseapp.com",
        projectId: "einol-6fbf6",
        storageBucket: "einol-6fbf6.firebasestorage.app",
        messagingSenderId: "430869133379",
        appId: "1:430869133379:web:6c6ca70527c521b98ffcf6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    let isRegMode = false;
    let currentChatId = null;
    let isCurrentChatChannel = false;

    // --- –ù–û–í–û–ï: –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ---
    function showToast(msg, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = msg;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-20px)';
            toast.style.transition = '0.4s';
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    // --- –ú–æ–±–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---
    function closeChatMobile() {
        document.getElementById('sidebar').classList.remove('hidden-mobile');
        document.getElementById('chat-window').classList.remove('active-mobile');
        currentChatId = null;
    }

    function setAuthInfo(text, color) {
        const info = document.getElementById('auth-info');
        info.innerText = text;
        info.style.color = color;
    }

    function toggleAuthMode() {
        isRegMode = !isRegMode;
        document.getElementById('auth-title').innerText = isRegMode ? "–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø" : "–í–•–û–î";
        document.getElementById('nickname').style.display = isRegMode ? "block" : "none";
        document.getElementById('main-btn').innerText = isRegMode ? "–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢" : "–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£";
        document.getElementById('toggle-text').innerText = isRegMode ? "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏" : "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç";
        setAuthInfo("", "");
    }

    async function handleAuth() {
        const email = document.getElementById('email').value.trim();
        const pass = document.getElementById('password').value.trim();
        const nick = document.getElementById('nickname').value.trim();
        const btn = document.getElementById('main-btn');

        if (!email || !pass) return setAuthInfo("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å", "#ff4d4d");
        
        btn.disabled = true;
        setAuthInfo("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º...", "#a0a5b5");

        try {
            if (isRegMode) {
                if (!nick.startsWith('@')) throw new Error("–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Å–∏–º–≤–æ–ª–∞ @");
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await res.user.updateProfile({ displayName: nick });
                await db.collection("users").doc(res.user.uid).set({ email, nick, uid: res.user.uid });
                showToast("–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!", "success");
            } else {
                await auth.signInWithEmailAndPassword(email, pass);
                showToast("–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!", "success");
            }
        } catch (e) { 
            let msg = e.message;
            if (e.code === 'auth/email-already-in-use') msg = "–≠—Ç–∞ –ø–æ—á—Ç–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞";
            if (e.code === 'auth/wrong-password') msg = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
            if (e.code === 'auth/user-not-found') msg = "–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
            setAuthInfo(msg, "#ff4d4d");
            showToast(msg, "error");
            btn.disabled = false;
        }
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'grid'; // –ù–∞ –º–æ–±–∏–ª–∫–∞—Ö CSS –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç –Ω–∞ flex
            document.getElementById('my-name').innerText = user.displayName || "User";
            document.getElementById('my-avatar').innerText = (user.displayName || "?")[1].toUpperCase();
            loadChats();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
            document.getElementById('main-btn').disabled = false;
        }
    });

    // --- –ù–û–í–û–ï: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (–î—Ä—É–∑—å—è –∏ –ö–∞–Ω–∞–ª—ã) ---
    async function searchTarget() {
        const query = document.getElementById('friend-search').value.trim(); // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤!
        if (!query) return;
        
        try {
            if (query.startsWith('#')) {
                // –ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–∞
                const snap = await db.collection("chats").where("isChannel", "==", true).where("name", "==", query).get();
                if (snap.empty) return showToast("–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ!", "error");
                
                const channelId = snap.docs[0].id;
                const channelData = snap.docs[0].data();
                
                if (!channelData.users.includes(auth.currentUser.uid)) {
                    await db.collection("chats").doc(channelId).update({
                        users: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)
                    });
                    showToast("–í—ã —É—Å–ø–µ—à–Ω–æ –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –∫–∞–Ω–∞–ª!", "success");
                } else {
                    showToast("–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ", "success");
                }
                document.getElementById('friend-search').value = "";
                openChat(channelId, channelData.name, true);
                
            } else if (query.startsWith('@')) {
                // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const snapshot = await db.collection("users").where("nick", "==", query).get();
                if (snapshot.empty) return showToast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∏–∫–∞ (–±–æ–ª—å—à–∏–µ/–º–∞–ª–µ–Ω—å–∫–∏–µ –±—É–∫–≤—ã)!", "error");

                const friend = snapshot.docs[0].data();
                const myUid = auth.currentUser.uid;
                if (myUid === friend.uid) return showToast("–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è!", "error");
                
                const chatId = myUid < friend.uid ? myUid + "_" + friend.uid : friend.uid + "_" + myUid;

                await db.collection("chats").doc(chatId).set({
                    users: firebase.firestore.FieldValue.arrayUnion(myUid, friend.uid),
                    nicks: [auth.currentUser.displayName, friend.nick],
                    isChannel: false
                }, { merge: true });
                
                document.getElementById('friend-search').value = "";
                showToast("–ß–∞—Ç —Å–æ–∑–¥–∞–Ω! –û–Ω –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ.", "success");
            } else {
                showToast("–í–≤–µ–¥–∏—Ç–µ @–Ω–∏–∫ –¥—Ä—É–≥–∞ –∏–ª–∏ #–∏–º—è –∫–∞–Ω–∞–ª–∞", "error");
            }
        } catch (e) {
            showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: " + e.message, "error");
        }
    }

    // --- –ù–û–í–û–ï: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ ---
    function openModal() { document.getElementById('channel-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('channel-modal').style.display = 'none'; }
    
    async function createChannel() {
        let name = document.getElementById('channel-name').value.trim();
        if (!name) return showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞!", "error");
        if (!name.startsWith('#')) name = '#' + name;

        try {
            const snap = await db.collection("chats").where("isChannel", "==", true).where("name", "==", name).get();
            if (!snap.empty) return showToast("–ö–∞–Ω–∞–ª —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –∑–∞–Ω—è—Ç!", "error");

            const myUid = auth.currentUser.uid;
            await db.collection("chats").add({
                isChannel: true,
                name: name,
                users: [myUid],
                admin: myUid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            closeModal();
            document.getElementById('channel-name').value = "";
            showToast("–ö–∞–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!", "success");
        } catch(e) {
            showToast("–û—à–∏–±–∫–∞: " + e.message, "error");
        }
    }

    // --- –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∞–Ω–∞–ª–æ–≤) ---
    function loadChats() {
        db.collection("chats").where("users", "array-contains", auth.currentUser.uid)
        .onSnapshot(snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                const data = doc.data();
                let displayName = "";
                let displayAvatar = "";
                let isChannel = false;

                if (data.isChannel) {
                    displayName = data.name;
                    displayAvatar = "üì¢";
                    isChannel = true;
                } else {
                    displayName = data.nicks.find(n => n !== auth.currentUser.displayName) || data.nicks[0];
                    displayAvatar = displayName.length > 1 ? displayName[1].toUpperCase() : "?";
                }

                const item = document.createElement('div');
                item.className = "chat-item glass";
                item.innerHTML = `
                    <div class="avatar">${displayAvatar}</div>
                    <div style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayName}</div>
                `;
                item.onclick = () => openChat(doc.id, displayName, isChannel);
                list.appendChild(item);
            });
        });
    }

    function openChat(id, name, isChannel) {
        currentChatId = id;
        isCurrentChatChannel = isChannel;
        
        // –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–∫–æ–Ω
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('hidden-mobile');
            document.getElementById('chat-window').classList.add('active-mobile');
        }

        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        document.getElementById('chat-title').innerText = name;
        document.getElementById('chat-avatar').innerText = isChannel ? "üì¢" : (name.length > 1 ? name[1].toUpperCase() : "?");

        db.collection("chats").doc(id).collection("messages").orderBy("timestamp", "asc")
        .onSnapshot(snap => {
            const cont = document.getElementById('msg-container');
            cont.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const div = document.createElement('div');
                div.className = `msg ${d.sender === auth.currentUser.uid ? 'out' : 'in'}`;
                
                let html = '';
                // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ –∫–∞–Ω–∞–ª–∞—Ö, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç—ã
                if (isChannel && d.sender !== auth.currentUser.uid && d.senderNick) {
                    html += `<div style="font-size: 11px; color: var(--accent); margin-bottom: 5px; font-weight: 600;">${d.senderNick}</div>`;
                }

                if (d.type === 'image') {
                    html += `<img src="${d.url}" onclick="window.open('${d.url}', '_blank')">`;
                } else if (d.type === 'audio') {
                    html += `<audio controls src="${d.url}"></audio>`;
                } else {
                    html += d.text;
                }
                
                div.innerHTML = html;
                cont.appendChild(div);
            });
            cont.scrollTop = cont.scrollHeight;
        });
    }

    // –¢–µ–∫—Å—Ç
    function sendMsg() {
        const input = document.getElementById('m-input');
        if (!input.value.trim() || !currentChatId) return;
        
        db.collection("chats").doc(currentChatId).collection("messages").add({
            type: 'text',
            text: input.value,
            sender: auth.currentUser.uid,
            senderNick: auth.currentUser.displayName, // –ù—É–∂–Ω–æ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = "";
    }

    // –§–æ—Ç–æ
    async function uploadImage(event) {
        const file = event.target.files[0];
        if (!file || !currentChatId) return;
        
        showToast("–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...", "success");
        const fileRef = storage.ref(`chats/${currentChatId}/images/${Date.now()}_${file.name}`);
        try {
            const snapshot = await fileRef.put(file);
            const url = await snapshot.ref.getDownloadURL();
            
            await db.collection("chats").doc(currentChatId).collection("messages").add({
                type: 'image',
                url: url,
                sender: auth.currentUser.uid,
                senderNick: auth.currentUser.displayName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: " + e.message, "error");
        }
    }

    // –ì–°
    let mediaRecorder;
    let audioChunks = [];

    async function startRecording() {
        if (!currentChatId) return;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                showToast("–û—Ç–ø—Ä–∞–≤–∫–∞ –ì–°...", "success");
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const fileRef = storage.ref(`chats/${currentChatId}/audio/${Date.now()}.webm`);
                
                try {
                    const snapshot = await fileRef.put(audioBlob);
                    const url = await snapshot.ref.getDownloadURL();
                    
                    await db.collection("chats").doc(currentChatId).collection("messages").add({
                        type: 'audio',
                        url: url,
                        sender: auth.currentUser.uid,
                        senderNick: auth.currentUser.displayName,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) {
                    showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ì–°: " + e.message, "error");
                }
            };
            
            mediaRecorder.start();
            document.getElementById('mic-btn').classList.add('recording');
        } catch (e) {
            showToast("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É! –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.", "error");
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            document.getElementById('mic-btn').classList.remove('recording');
        }
    }

    function logout() { auth.signOut(); }
</script>
</body>
</html>
