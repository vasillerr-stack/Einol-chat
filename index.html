<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Enjol Messenger | Bulletproof</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #000000;
            --bg-panel: #0a0a0b;
            --bg-item: #161618;
            --accent: #7c4dff;
            --accent-dim: #5e35b1;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
            --radius-xl: 24px;
            --radius-m: 16px;
        }

        /* –û–±–Ω—É–ª–µ–Ω–∏–µ –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            height: 100dvh; 
            width: 100%;
            font-family: 'Montserrat', sans-serif; 
            background: var(--bg-deep); 
            color: var(--text-main); 
            overflow: hidden; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –æ–±—â–∏–π —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            position: fixed; 
        }

        #app { 
            display: none; /* –ü–æ–∫–∞–∂–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ Auth */
            height: 100dvh; 
            width: 100%; 
            display: flex; 
            position: relative; 
        }

        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar { 
            width: 380px; 
            background: var(--bg-panel); 
            border-right: 1px solid #1a1a1a; 
            display: flex; 
            flex-direction: column; 
            z-index: 10;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* –û–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-window { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: var(--bg-deep); 
            z-index: 5;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; inset: 0; }
            .chat-window { 
                width: 100%; 
                position: absolute; 
                inset: 0; 
                transform: translateX(100%); 
                z-index: 20;
            }
            body.chat-open .sidebar { transform: translateX(-100%); }
            body.chat-open .chat-window { transform: translateX(0); }
        }

        /* –®–∞–ø–∫–∏ */
        .header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #1a1a1a;
            min-height: 70px;
            background: var(--bg-panel);
        }

        /* –ü–æ–∏—Å–∫ */
        .search-area { padding: 10px 15px; position: relative; }
        .search-bar {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-item);
            border: 1px solid #222;
            border-radius: 12px;
            color: white;
            font-family: inherit;
        }
        #search-results {
            position: absolute;
            top: 60px; left: 15px; right: 15px;
            background: #1c1c1e;
            border-radius: 12px;
            border: 1px solid #333;
            z-index: 100;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-radius: var(--radius-m);
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.2s;
        }
        .chat-item:hover { background: var(--bg-item); }
        .chat-item.active { background: #2c2c2e; }

        /* –ê–≤–∞—Ç–∞—Ä–∫–∏ */
        .avatar {
            width: 50px; height: 50px;
            border-radius: 16px;
            background: #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            user-select: none;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }
        .msg.in { align-self: flex-start; background: #1c1c1e; border-bottom-left-radius: 4px; }
        .msg.out { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 4px; }
        .msg-time { font-size: 10px; opacity: 0.5; margin-top: 5px; display: block; text-align: right; }
        .msg-sender { font-size: 11px; font-weight: 700; color: var(--accent); margin-bottom: 4px; display: block; }

        /* –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ */
        .input-area {
            padding: 15px 20px calc(15px + env(safe-area-inset-bottom));
            background: var(--bg-panel);
            display: flex;
            align-items: center;
            gap: 12px;
            border-top: 1px solid #1a1a1a;
        }
        .input-wrap {
            flex: 1;
            background: var(--bg-item);
            border-radius: 15px;
            padding: 10px 15px;
            border: 1px solid #222;
        }
        .input-wrap input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            font-family: inherit;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            backdrop-filter: blur(8px);
        }
        .modal-side {
            position: fixed;
            left: -100%; top: 0; bottom: 0;
            width: 320px;
            background: var(--bg-panel);
            z-index: 2100;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 40px 25px;
            border-right: 1px solid #1a1a1a;
        }
        .modal-side.open { left: 0; }

        /* Auth Screen */
        #auth-screen {
            position: fixed; inset: 0;
            background: #000;
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-card {
            background: var(--bg-panel);
            padding: 40px;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #1a1a1a;
        }
        .auth-card input {
            width: 100%;
            padding: 15px;
            margin-bottom: 12px;
            background: var(--bg-item);
            border: 1px solid #222;
            color: white;
            border-radius: 12px;
            font-size: 16px;
        }
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: white;
            color: black;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }

        .back-btn { display: none; cursor: pointer; font-size: 24px; color: var(--accent); }
        @media (max-width: 768px) { .back-btn { display: block; } }
        
        .owner-badge { 
            background: #ff9500; color: black; 
            font-size: 10px; font-weight: 800; 
            padding: 2px 6px; border-radius: 4px; 
            vertical-align: middle; margin-left: 5px;
        }
    </style>
</head>
<body id="main-body">

<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div class="modal-side" id="profile-modal">
    <div style="text-align: center;">
        <div class="avatar" id="p-avatar" style="width: 100px; height: 100px; font-size: 50px; margin: 0 auto 20px; border-radius: 30px;">üë§</div>
        <h2 id="p-nick">@nick</h2>
        <div id="p-owner-label" style="display:none; margin-top:5px;"><span class="owner-badge">OWNER</span></div>
        
        <div style="margin-top: 30px; text-align: left;">
            <label style="font-size: 11px; color: var(--text-dim); font-weight: 700;">–û –°–ï–ë–ï</label>
            <div id="p-about-box" style="margin-top: 8px; color: var(--text-main); line-height: 1.5; background: var(--bg-item); padding: 15px; border-radius: 12px; min-height: 60px; white-space: pre-wrap;"></div>
        </div>
    </div>
    <button class="btn-primary" onclick="closeAllModals()" style="margin-top: 30px; background: var(--bg-item); color: white;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div class="modal-side" id="my-profile-modal">
    <div style="text-align: center;">
        <div class="avatar" id="my-p-emoji" onclick="cycleMyEmoji()" style="width: 90px; height: 90px; font-size: 45px; margin: 0 auto 15px; cursor: pointer; border: 2px dashed var(--accent);">üë§</div>
        <p style="font-size: 12px; color: var(--accent); margin-bottom: 10px;">–ù–∞–∂–º–∏ –Ω–∞ —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</p>
        <h2 id="my-p-nick">@nick</h2>
    </div>
    <div style="margin-top: 30px;">
        <label style="font-size: 11px; color: var(--text-dim); font-weight: 700;">–ò–ó–ú–ï–ù–ò–¢–¨ –û–ü–ò–°–ê–ù–ò–ï</label>
        <textarea id="my-p-about-input" style="width: 100%; background: var(--bg-item); border: 1px solid #222; border-radius: 12px; color: white; padding: 15px; margin-top: 8px; resize: none; height: 120px; font-family: inherit; font-size: 14px;"></textarea>
        <button class="btn-primary" onclick="updateMyProfile()" style="background: var(--accent); color: white;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
    </div>
    <button onclick="auth.signOut()" style="position: absolute; bottom: 30px; left: 25px; color: #ff453a; background: none; border: none; font-weight: 600; cursor: pointer;">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
</div>

<div id="auth-screen">
    <div class="auth-card">
        <h1 style="margin-bottom: 10px;">Enjol</h1>
        <p id="auth-subtitle" style="color: var(--text-dim); margin-bottom: 30px; font-size: 14px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Onyx Elite</p>
        
        <input type="email" id="auth-email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞">
        <input type="text" id="auth-nick" placeholder="–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º (–±–µ–∑ @)" style="display:none">
        <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        
        <button class="btn-primary" id="auth-btn" onclick="processAuth()">–í–æ–π—Ç–∏</button>
        <p onclick="toggleAuthMode()" id="auth-toggle" style="margin-top: 20px; color: var(--text-dim); font-size: 13px; cursor: pointer;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –°–æ–∑–¥–∞—Ç—å</p>
    </div>
</div>

<div id="app">
    <div class="sidebar" id="app-sidebar">
        <div class="header">
            <div onclick="openMyProfile()" style="cursor:pointer; font-size: 24px;">‚ò∞</div>
            <div style="flex: 1; text-align: center; font-weight: 700; letter-spacing: 1px;">ENJOL</div>
            <div style="width: 24px;"></div>
        </div>

        <div class="search-area">
            <input type="text" class="search-bar" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É..." oninput="handleSearch()">
            <div id="search-results"></div>
        </div>

        <div class="chat-list" id="global-chat-list">
            </div>
    </div>

    <div class="chat-window" id="app-chat-window">
        <div class="header" id="chat-header" style="display:none">
            <div class="back-btn" onclick="closeChatMobile()">‚Üê</div>
            <div class="avatar" id="active-chat-avatar" onclick="openPartnerProfile()" style="width: 40px; height: 40px; font-size: 20px; cursor: pointer;">üë§</div>
            <div style="flex:1; cursor: pointer;" onclick="openPartnerProfile()">
                <div id="active-chat-name" style="font-weight: 700;">–ò–º—è –ß–∞—Ç–∞</div>
                <div id="active-chat-status" style="font-size: 11px; color: var(--accent);">–≤ —Å–µ—Ç–∏</div>
            </div>
        </div>

        <div class="messages-container" id="messages-box">
            <div style="margin: auto; text-align: center; color: var(--text-dim);">
                <div style="font-size: 50px; margin-bottom: 10px;">‚ú®</div>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ<br>—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
            </div>
        </div>

        <div class="input-area" id="chat-input-zone" style="display:none">
            <div class="input-wrap">
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
            </div>
            <div onclick="sendMessage()" style="cursor:pointer; font-size: 24px; color: var(--accent);">‚û§</div>
        </div>
    </div>
</div>

<script>
    // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyBoFqIEnH2J-d0dBe9FJ7cQWATr9n5fKDk",
        authDomain: "einol-6fbf6.firebaseapp.com",
        projectId: "einol-6fbf6",
        storageBucket: "einol-6fbf6.firebasestorage.app",
        messagingSenderId: "430869133379",
        appId: "1:430869133379:web:6c6ca70527c521b98ffcf6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
    const OWNER_UID = "MyGoO65rfh6ceu3hzxrfrkq2OqfY2";
    let isReg = false;
    let activeChatId = null;
    let activePartnerUid = null;
    let myData = { nick: '', emoji: 'üë§', about: '' };

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
    const $ = id => document.getElementById(id);
    const cleanNick = n => n ? n.replace(/^@/, '') : 'User';
    const formatNick = n => '@' + cleanNick(n);

    function closeAllModals() {
        $('overlay').style.display = 'none';
        $('profile-modal').classList.remove('open');
        $('my-profile-modal').classList.remove('open');
    }

    function closeChatMobile() {
        document.getElementById('main-body').classList.remove('chat-open');
    }

    // --- –ü–æ–∏—Å–∫ ---
    async function handleSearch() {
        const query = $('user-search').value.trim().toLowerCase().replace(/^@/, '');
        const resultsBox = $('search-results');
        
        if (!query) { resultsBox.style.display = 'none'; return; }
        
        resultsBox.innerHTML = '<div style="padding:15px; font-size:12px; color:#888;">–ü–æ–∏—Å–∫...</div>';
        resultsBox.style.display = 'block';

        try {
            const snap = await db.collection("users")
                .where("nick_low", ">=", query)
                .where("nick_low", "<=", query + '\uf8ff')
                .limit(5).get();

            resultsBox.innerHTML = "";
            if (snap.empty) {
                resultsBox.innerHTML = '<div style="padding:15px; font-size:12px; color:#888;">–ù–∏–∫—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                return;
            }

            snap.forEach(doc => {
                const u = doc.data();
                const div = document.createElement('div');
                div.className = "chat-item";
                div.innerHTML = `<div class="avatar" style="width:35px; height:35px; font-size:16px;">${u.emoji || 'üë§'}</div>
                                 <div style="font-weight:600; font-size:14px;">${formatNick(u.nick)}</div>`;
                div.onclick = () => {
                    resultsBox.style.display = 'none';
                    $('user-search').value = "";
                    if (u.uid === auth.currentUser.uid) openMyProfile();
                    else startPrivateChat(u);
                };
                resultsBox.appendChild(div);
            });
        } catch (e) { console.error("Search Error:", e); }
    }

    async function startPrivateChat(partner) {
        const myUid = auth.currentUser.uid;
        const chatId = myUid < partner.uid ? `${myUid}_${partner.uid}` : `${partner.uid}_${myUid}`;
        
        await db.collection("chats").doc(chatId).set({
            users: [myUid, partner.uid],
            nicks: { [myUid]: myData.nick, [partner.uid]: partner.nick },
            emojis: { [myUid]: myData.emoji, [partner.uid]: partner.emoji || 'üë§' },
            isChannel: false,
            lastMsg: ""
        }, { merge: true });

        openChat(chatId, partner.nick, partner.emoji || 'üë§', partner.uid);
    }

    // --- –ß–∞—Ç ---
    function openChat(id, name, emoji, partnerUid = null) {
        activeChatId = id;
        activePartnerUid = partnerUid;

        $('chat-header').style.display = 'flex';
        $('chat-input-zone').style.display = 'flex';
        $('active-chat-name').innerText = formatNick(name);
        $('active-chat-avatar').innerText = emoji;
        $('messages-box').innerHTML = "";

        document.getElementById('main-body').classList.add('chat-open');

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        db.collection("chats").doc(id).collection("messages").orderBy("timestamp", "asc")
        .onSnapshot(snap => {
            if (activeChatId !== id) return;
            const box = $('messages-box');
            box.innerHTML = "";
            
            snap.forEach(doc => {
                const m = doc.data();
                const isOut = m.sender === auth.currentUser.uid;
                const time = m.timestamp ? m.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "...";
                
                const div = document.createElement('div');
                div.className = `msg ${isOut ? 'out' : 'in'}`;
                div.innerHTML = `${m.text}<span class="msg-time">${time}</span>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    async function sendMessage() {
        const text = $('msg-input').value.trim();
        if (!text || !activeChatId) return;

        const msgData = {
            text: text,
            sender: auth.currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        $('msg-input').value = "";
        await db.collection("chats").doc(activeChatId).collection("messages").add(msgData);
        await db.collection("chats").doc(activeChatId).update({ lastMsg: text });
    }

    // --- –ü—Ä–æ—Ñ–∏–ª—å ---
    function openMyProfile() {
        $('my-p-nick').innerText = formatNick(myData.nick);
        $('my-p-emoji').innerText = myData.emoji;
        $('my-p-about-input').value = myData.about || "";
        $('overlay').style.display = 'block';
        $('my-profile-modal').classList.add('open');
    }

    function cycleMyEmoji() {
        const list = ["üë§","üê±","ü¶ä","ü§ñ","üëª","üëΩ","üåü","üî•","üíé","üçÑ","üçÄ","üëë","‚ö°Ô∏è","ü™ê"];
        let idx = list.indexOf(myData.emoji);
        myData.emoji = list[(idx + 1) % list.length];
        $('my-p-emoji').innerText = myData.emoji;
    }

    async function updateMyProfile() {
        const newAbout = $('my-p-about-input').value.trim();
        try {
            await db.collection("users").doc(auth.currentUser.uid).update({
                about: newAbout,
                emoji: myData.emoji
            });
            alert("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!");
            closeAllModals();
        } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
    }

    async function openPartnerProfile() {
        if (!activePartnerUid) return;
        const doc = await db.collection("users").doc(activePartnerUid).get();
        if (doc.exists) {
            const u = doc.data();
            $('p-avatar').innerText = u.emoji || 'üë§';
            $('p-nick').innerText = formatNick(u.nick);
            $('p-about-box').innerText = u.about || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Å—Ç–∞–≤–∏–ª –æ–ø–∏—Å–∞–Ω–∏—è.";
            $('p-owner-label').style.display = (u.uid === OWNER_UID) ? 'block' : 'none';
            
            $('overlay').style.display = 'block';
            $('profile-modal').classList.add('open');
        }
    }

    // --- –°–∏—Å—Ç–µ–º–Ω–æ–µ (Auth & Load) ---
    auth.onAuthStateChanged(async user => {
        if (user) {
            const userDoc = await db.collection("users").doc(user.uid).get();
            if (userDoc.exists) {
                myData = userDoc.data();
                // –§–∏–∫—Å –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –±–µ–∑ nick_low
                if (!myData.nick_low) db.collection("users").doc(user.uid).update({ nick_low: myData.nick.toLowerCase() });
            }
            $('auth-screen').style.display = 'none';
            $('app').style.display = 'flex';
            loadUserChats();
        } else {
            $('auth-screen').style.display = 'flex';
            $('app').style.display = 'none';
        }
    });

    function loadUserChats() {
        db.collection("chats").where("users", "array-contains", auth.currentUser.uid)
        .onSnapshot(snap => {
            const list = $('global-chat-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                const c = doc.data();
                const isChannel = c.isChannel;
                let chatName, chatEmoji, partnerId = null;

                if (isChannel) {
                    chatName = c.name; chatEmoji = "üì¢";
                } else {
                    partnerId = c.users.find(u => u !== auth.currentUser.uid);
                    chatName = c.nicks[partnerId] || "User";
                    chatEmoji = c.emojis[partnerId] || "üë§";
                }

                const item = document.createElement('div');
                item.className = `chat-item ${activeChatId === doc.id ? 'active' : ''}`;
                item.innerHTML = `<div class="avatar">${chatEmoji}</div>
                                  <div style="flex:1">
                                    <div style="font-weight:700;">${isChannel ? chatName : formatNick(chatName)}</div>
                                    <div style="font-size:12px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:180px;">${c.lastMsg || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                                  </div>`;
                item.onclick = () => openChat(doc.id, chatName, chatEmoji, partnerId);
                list.appendChild(item);
            });
        });
    }

    // --- –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ---
    function toggleAuthMode() {
        isReg = !isReg;
        $('auth-nick').style.display = isReg ? 'block' : 'none';
        $('auth-btn').innerText = isReg ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í–æ–π—Ç–∏';
        $('auth-subtitle').innerText = isReg ? '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞–º' : '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Onyx Elite';
        $('auth-toggle').innerText = isReg ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏' : '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –°–æ–∑–¥–∞—Ç—å';
    }

    async function processAuth() {
        const email = $('auth-email').value.trim();
        const pass = $('auth-pass').value.trim();
        const nick = $('auth-nick').value.trim();

        if (!email || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

        try {
            if (isReg) {
                if (!nick) return alert("–ü—Ä–∏–¥—É–º–∞–π –Ω–∏–∫!");
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await res.user.updateProfile({ displayName: nick });
                await db.collection("users").doc(res.user.uid).set({
                    uid: res.user.uid,
                    nick: nick,
                    nick_low: nick.toLowerCase(),
                    emoji: "üë§",
                    about: ""
                });
            } else {
                await auth.signInWithEmailAndPassword(email, pass);
            }
        } catch (e) { alert(e.message); }
    }

</script>
</body>
</html>
